<ng-container>
    <div *ngIf="!error && !joined">
        <h2 class="connecting-message">
            Connecting to call...
        </h2>
    </div>
    <div *ngIf="error">
        <error-message [error]="error" (reset)="leaveCall()"></error-message>
    </div>
    <!-- Virtual Background Menu -->
    <div *ngIf="showVirtualBgMenu && joined" class="virtual-bg-overlay" (click)="toggleVirtualBgMenu()">
        <div class="virtual-bg-menu" (click)="$event.stopPropagation()">
            <div class="virtual-bg-header">
                <h3>Virtual Background</h3>
                <button class="close-btn" (click)="toggleVirtualBgMenu()">Ã—</button>
            </div>
            <div *ngIf="isLoadingVirtualBg" class="loading-overlay">
                <div class="spinner"></div>
                <p>Applying background...</p>
            </div>
            <div class="virtual-bg-options" [class.loading]="isLoadingVirtualBg">
                <div *ngFor="let option of virtualBackgroundOptions" class="virtual-bg-option"
                    [class.active]="(option.type === 'none' && currentVirtualBg === 'none') || (option.type === 'blur' && currentVirtualBg === 'blur') || (option.type === 'image' && currentVirtualBg === 'image' && option.value === currentVirtualBgValue)"
                    (click)="applyVirtualBackground(option)">
                    <div class="option-preview">
                        <img *ngIf="option.thumbnail" [src]="option.thumbnail" [alt]="option.label">
                        <div *ngIf="option.type === 'blur'" class="blur-preview">
                            <div class="blur-circle"></div>
                        </div>
                        <div *ngIf="option.type === 'none'" class="none-preview">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </div>
                    </div>
                    <span class="option-label">{{ option.label }}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="flex items-center p-4 min-w-screen bg-white  text-black">
        <div *ngIf="joined" class="flex-col inline-flex justify-start items-start gap-3">
            <div (click)="isLayoutDisabled(val) ? null : changeLayout(val)" *ngFor="let val of layouts"
                class="layout-container border-2 flex items-center justify-center p-4 rounded overflow-hidden cursor-pointer"
                [ngClass]="{
            'selected': val === selectedLayout,
            'opacity-50 cursor-not-allowed': isLayoutDisabled(val)}">
                <div class="flex justify-center items-center">
                    <div class="h-full max-w-11 max-h-8 inline-flex flex-col justify-start items-start overflow-hidden">
                        <div class="w-11 h-8 flex flex-col justify-center items-center overflow-hidden">
                            <div class="">
                                <img class="w-auto h-full"
                                    [src]="'https://ts-conference.imgix.net/common/illustrations/stage_vg_layout_' + val + '.svg'"
                                    alt="VG layout illustration" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="inline-block rounded overflow-auto relative" [style.height]="'500px'" [style.width]="'1280px'">

            
            <!-- NEW: Local Text Overlay -->
            <div *ngIf="showTextOverlay" class="local-text-overlay">
                {{ OVERLAY_TEXT }}
            </div>
            
            <!-- NEW: Local Image Overlay -->
            <img *ngIf="showImageOverlay" 
                 [src]="OVERLAY_IMAGE_URL" 
                 alt="Overlay Logo" 
                 class="local-image-overlay">
            
            <!-- NEW: Horizontal volume slider overlay for backstage users -->
            <!-- Unified volume control for backstage users -->
            <div *ngIf="joined && localParticipantRole === 'backstage'" class="absolute bottom-4 right-4 z-10">
                <div class="flex items-center p-3 bg-black bg-opacity-75 rounded-lg shadow-lg">
                    <label class="text-xs font-medium text-white mr-2">Audio Volume</label>
                    <input 
                        type="range" 
                        min="0" 
                        max="1" 
                        step="0.1" 
                        [value]="mainAudioVolume" 
                        (input)="handleMainAudioVolumeChange($event)"
                        class="w-24 h-2 bg-gray-400 rounded-lg cursor-pointer"
                    >
                    <span class="text-xs text-white ml-2">{{ (mainAudioVolume * 100) | number:'1.0-0' }}%</span>
                </div>
            </div>
            
            <div *ngIf="joined" class="mainstage-container h-full w-full" #mainstageContainer>
                <div *ngIf="getStageParticipants().length === 0"
                    class="carousel bg-gray-100 banner-image-container h-full w-full flex items-center justify-center">
                    <div class="flex flex-col justify-center items-center">
                        <img class="" src="../../assets/blackicon.svg">
                        <p class="font-bold mt-5 text-3xl text-black tracking-wider">
                            The stage is empty</p>
                    </div>
                </div>

                <div class="layout-wrapper h-full w-full" [attr.data-layout]="selectedLayout"
                    [attr.data-peer-count]="getStageParticipants().length">

                    <!-- ========== TILED LAYOUT ========== -->
                    <ng-container *ngIf="selectedLayout === VideoLayout.TILED">
                        <div class="tiled-container h-full w-full" role="grid">
                            <div class="tiled-grid" [attr.aria-rowcount]="0" [attr.aria-colcount]="0">
                                <ng-container>
                                    <div class="tiled-item"
                                        *ngFor="let participant of getStageParticipants(); trackBy: trackByPeerId; let i = index"
                                        [attr.data-peer-id]="participant.id" role="gridcell"
                                        [attr.aria-rowindex]="getRowIndex(i)"
                                        [attr.aria-colindex]="(i % getCols()) + 1">
                                        <app-hv-mainstage-speaker
                                            [joined]="joined"
                                            [videoReady]="participant.videoReady" [audioReady]="participant.audioReady"
                                            [userName]="participant.userName" [local]="false"
                                            [videoTrack]="participant.videoTrack" [audioTrack]="participant.audioTrack"
                                            [role]="participant.role" [isScreenSharing]="isScreenSharing"
                                            (roleChangeClick)="toggleParticipantRole(participant)"></app-hv-mainstage-speaker>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-container>

                    <!-- ========== PINNED VERTICAL LAYOUT  ========== -->
                    <ng-container *ngIf="selectedLayout === VideoLayout.PINNED_VERTICAL">
                        <div class="pinned-vertical-layout h-full w-full" role="region"
                            aria-label="Vertical pinned layout">

                            <!-- Main area for screen share or primary content -->
                            <div class="main-area" role="main">
                                <div *ngIf="isScreenSharing && screenSharingParticipant"
                                    class="screen-share-container h-full w-full">
                                    <app-hv-mainstage-screen-share [screenShareView]="isScreenSharing"
                                        [screenVideoReady]="screenSharingParticipant.screenVideoReady"
                                        [screenAudioReady]="screenSharingParticipant.screenAudioReady"
                                        [userName]="screenSharingParticipant.userName"
                                        [local]="screenSharingParticipant.local"
                                        [screenVideoTrack]="screenSharingParticipant.screenVideoTrack"
                                        [screenAudioTrack]="screenSharingParticipant.screenAudioTrack"
                                        [role]="screenSharingParticipant.role"
                                        [screenSharingParticipant]="screenSharingParticipant">
                                    </app-hv-mainstage-screen-share>
                                </div>
                            </div>

                            <!-- vertical bottom bar for all users -->
                            <div class="flex items-center pinned-vertical-bottom" role="complementary"
                                [attr.aria-label]="'Participant bar with ' + getStageParticipants().length + ' participants'">
                                <div class="bottom-content" role="list">
                                    <div
                                        class="bottom-inner flex hide-scroll items-center max-h-full overflow-x-auto overflow-y-hidden scroll w-full">
                                        <div class="bottom-item"
                                            *ngFor="let participant of getStageParticipants(); trackBy: trackByPeerId; let i = index"
                                            role="listitem" [attr.data-peer-id]="participant.id">
                                            <app-hv-mainstage-speaker
                                                [joined]="joined"
                                                [videoReady]="participant.videoReady"
                                                [audioReady]="participant.audioReady" [userName]="participant.userName"
                                                [local]="false" [videoTrack]="participant.videoTrack"
                                                [audioTrack]="participant.audioTrack" [role]="participant.role"
                                                [isScreenSharing]="isScreenSharing"
                                                (roleChangeClick)="toggleParticipantRole(participant)"></app-hv-mainstage-speaker>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ng-container>

                    <!-- ========== PINNED HORIZONTAL LAYOUT  ========== -->
                    <ng-container *ngIf="selectedLayout === VideoLayout.PINNED_HORIZONTAL">
                        <div class="pinned-horizontal-layout h-full w-full" role="region"
                            aria-label="Horizontal pinned layout">

                            <!-- Main area for screen share or primary content -->
                            <div class="main-area" role="main">
                                <div *ngIf="isScreenSharing && screenSharingParticipant"
                                    class="screen-share-container h-full w-full">
                                    <app-hv-mainstage-screen-share [screenShareView]="isScreenSharing"
                                        [screenVideoReady]="screenSharingParticipant.screenVideoReady"
                                        [screenAudioReady]="screenSharingParticipant.screenAudioReady"
                                        [userName]="screenSharingParticipant.userName"
                                        [local]="screenSharingParticipant.local"
                                        [screenVideoTrack]="screenSharingParticipant.screenVideoTrack"
                                        [screenAudioTrack]="screenSharingParticipant.screenAudioTrack"
                                        [role]="screenSharingParticipant.role"
                                        [screenSharingParticipant]="screenSharingParticipant">
                                    </app-hv-mainstage-screen-share>
                                </div>
                            </div>

                            <!-- horizontal sidebar for all users -->
                            <div class="pinned-horizontal-sidebar" role="complementary"
                                [attr.aria-label]="'Participant sidebar with ' + getStageParticipants().length + ' participants'">
                                <div class="sidebar-content" role="list">
                                    <div class="sidebar-inner">
                                        <div class="sidebar-item"
                                            *ngFor="let participant of getStageParticipants(); trackBy: trackByPeerId; let i = index"
                                            role="listitem" [attr.data-peer-id]="participant.id">
                                            <app-hv-mainstage-speaker
                                                [isScreenSharing]="isScreenSharing"
                                                [joined]="joined"
                                                [videoReady]="participant.videoReady"
                                                [audioReady]="participant.audioReady" [userName]="participant.userName"
                                                [local]="false" [videoTrack]="participant.videoTrack"
                                                [audioTrack]="participant.audioTrack" [role]="participant.role"
                                                (roleChangeClick)="toggleParticipantRole(participant)"></app-hv-mainstage-speaker>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ng-container>

                    <!-- ========== FULL SCREEN (Screen Share) ========== -->
                    <ng-container *ngIf="selectedLayout === VideoLayout.FULL_SCREEN">
                        <div class="fullscreen-layout h-full w-full" role="main">
                            <div *ngIf="isScreenSharing && screenSharingParticipant" class="h-full w-full">
                                <app-hv-mainstage-screen-share [screenShareView]="isScreenSharing"
                                    [screenVideoReady]="screenSharingParticipant.screenVideoReady"
                                    [screenAudioReady]="screenSharingParticipant.screenAudioReady"
                                    [userName]="screenSharingParticipant.userName"
                                    [local]="screenSharingParticipant.local"
                                    [screenVideoTrack]="screenSharingParticipant.screenVideoTrack"
                                    [screenAudioTrack]="screenSharingParticipant.screenAudioTrack"
                                    [role]="screenSharingParticipant.role"
                                    [screenSharingParticipant]="screenSharingParticipant">
                                </app-hv-mainstage-screen-share>
                            </div>
                        </div>
                        <ng-container
                            *ngFor="let participant of getStageParticipants(); trackBy: trackByPeerId; let i = index">
                            <app-audio-track [joined]="joined" [audioReady]="participant.audioReady"
                                [local]="participant.local" [audioTrack]="participant.audioTrack"
                                [role]="participant.role"></app-audio-track>
                        </ng-container>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
    <div *ngIf="joined" class="backstage-container min-w-screen bg-white">
        <div class="container-header backstage-header flex items-center justify-between">
            <div class="flex items-center gap-3">
                <h3>Backstage</h3>
                <!-- NEW: Volume icon for backstage mute/unmute -->
                <button 
                    *ngIf="joined && localParticipantRole === 'backstage'"
                    (click)="toggleMuteBackstage()"
                    class="p-1 rounded hover:bg-gray-100 transition-colors"
                    [title]="isBackstageMuted ? 'Unmute Backstage' : 'Mute Backstage'"
                >
                    <!-- Volume Off Icon (when muted) -->
                    <svg *ngIf="isBackstageMuted" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <line x1="23" y1="9" x2="17" y2="15"></line>
                        <line x1="17" y1="9" x2="23" y2="15"></line>
                    </svg>
                    <!-- Volume On Icon (when unmuted) -->
                    <svg *ngIf="!isBackstageMuted" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
            </div>
            
            <!-- NEW: Personal AV Controls (Always Available) -->
            <div *ngIf="joined" class="flex items-center gap-2">
                <!-- Microphone Toggle -->
                <button 
                    (click)="toggleLocalAudio()"
                    class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                    [class]="{
                        'bg-red-500 hover:bg-red-600 text-white': !getLocalParticipant()?.audioReady,
                        'bg-green-500 hover:bg-green-600 text-white': getLocalParticipant()?.audioReady
                    }"
                    [title]="getLocalParticipant()?.audioReady ? 'Mute Microphone' : 'Unmute Microphone'"
                >
                    <!-- Microphone Off -->
                    <svg *ngIf="!getLocalParticipant()?.audioReady" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>
                        <path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path>
                        <line x1="19" y1="19" x2="5" y2="5"></line>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    <!-- Microphone On -->
                    <svg *ngIf="getLocalParticipant()?.audioReady" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>

                <!-- Camera Toggle -->
                <button 
                    (click)="toggleLocalVideo()"
                    class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                    [class]="{
                        'bg-red-500 hover:bg-red-600 text-white': !getLocalParticipant()?.videoReady,
                        'bg-blue-500 hover:bg-blue-600 text-white': getLocalParticipant()?.videoReady
                    }"
                    [title]="getLocalParticipant()?.videoReady ? 'Turn Off Camera' : 'Turn On Camera'"
                >
                    <!-- Camera Off -->
                    <svg *ngIf="!getLocalParticipant()?.videoReady" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.66 6H14a2 2 0 0 1 2 2v2.34l1 1L22 8v8"></path>
                        <path d="M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2l10 10Z"></path>
                        <line x1="2" y1="2" x2="22" y2="22"></line>
                    </svg>
                    <!-- Camera On -->
                    <svg *ngIf="getLocalParticipant()?.videoReady" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                </button>

                <!-- Screen Share Toggle -->
                <button 
                    (click)="toggleScreenShare()"
                    class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                    [class]="{
                        'bg-purple-500 hover:bg-purple-600 text-white': isScreenSharing,
                        'bg-gray-500 hover:bg-gray-600 text-white': !isScreenSharing
                    }"
                    [title]="isScreenSharing ? 'Stop Screen Share' : 'Start Screen Share'"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                        <path d="M10 4v4"></path>
                        <path d="M14 4v4"></path>
                        <path d="M4 8h16"></path>
                    </svg>
                </button>

                <!-- Virtual Background Toggle -->
                <button 
                    (click)="toggleVirtualBgMenu()"
                    class="p-2 rounded-lg transition-all duration-200 hover:scale-105 bg-indigo-500 hover:bg-indigo-600 text-white"
                    title="Virtual Background"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>

                <!-- Leave Call -->
                <button 
                    (click)="leaveCall()"
                    class="p-2 rounded-lg transition-all duration-200 hover:scale-105 bg-red-600 hover:bg-red-700 text-white ml-2"
                    title="Leave Call"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="backstage-content" [style.height]="'180px'">
            <div class="backstage-scroll">
                <video-tile *ngFor="let participant of getBackstageParticipants()" [sidebarView]="true"
                    [screenShareView]="false" [joined]="joined"
                    [videoReady]="participant.videoReady" [audioReady]="participant.audioReady"
                    [screenVideoReady]="participant.screenVideoReady" [screenAudioReady]="participant.screenAudioReady"
                    [userName]="participant.userName" [local]="false" [videoTrack]="participant.videoTrack"
                    [audioTrack]="participant.audioTrack" [screenVideoTrack]="participant.screenVideoTrack"
                    [screenAudioTrack]="participant.screenAudioTrack" [isScreenSharing]="isScreenSharing"
                    [role]="participant.role" (roleChangeClick)="toggleParticipantRole(participant)"
                    [screenSharingParticipant]="screenSharingParticipant"></video-tile>

                <div *ngIf="getBackstageParticipants().length === 0" class="empty-state items-center">
                    Backstage is empty
                </div>
            </div>
        </div>
    </div>

</ng-container>